{% extends 'base.html' %}

{% block content %}
<div class="flex h-screen overflow-hidden bg-gray-900">
    <!-- Mobile overlay -->
    <div id="mobile-overlay" class="fixed inset-0 z-20 bg-black bg-opacity-50 hidden md:hidden"
        onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <aside id="sidebar"
        class="fixed inset-y-0 left-0 z-30 w-64 transform -translate-x-full transition-transform duration-300 ease-in-out md:relative md:translate-x-0 bg-black flex flex-col">
        <div class="p-4 flex-none">
            <button onclick="createNewChat()"
                class="w-full text-left px-4 py-3 border border-gray-600 rounded-md text-white hover:bg-gray-800 transition flex items-center gap-2">
                <i class="fas fa-plus"></i> New Chat
            </button>
        </div>

        <div class="flex-1 overflow-y-auto custom-scrollbar px-2 space-y-2" id="chat-list">
            <!-- Chat items appended here -->
        </div>

        <div class="p-4 border-t border-gray-800 flex-none">
            <button onclick="logout()"
                class="flex items-center gap-2 text-gray-400 hover:text-white transition w-full px-2 py-2 rounded">
                <i class="fas fa-sign-out-alt"></i> Log out
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col min-w-0 bg-gray-800 relative">
        <!-- Mobile Header -->
        <header class="md:hidden flex items-center p-4 border-b border-gray-700 bg-gray-900 text-white flex-none">
            <button onclick="toggleSidebar()" class="mr-4 text-gray-400 hover:text-white">
                <i class="fas fa-bars text-xl"></i>
            </button>
            <span class="font-semibold">Lumina AI</span>
        </header>

        <!-- Messages Area -->
        <div id="messages-container" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 custom-scrollbar pb-32">
            <!-- Welcome View (Shown when no chat) -->
            <div id="welcome-view" class="h-full flex flex-col items-center justify-center text-gray-100 opacity-80">
                <div
                    class="w-16 h-16 bg-white rounded-full flex items-center justify-center mb-6 text-gray-900 text-3xl">
                    <i class="fas fa-robot"></i>
                </div>
                <h1 class="text-3xl font-bold mb-2">Lumina AI</h1>
                <p class="text-lg">How can I help you today?</p>
            </div>
            <!-- Messages appended here -->
        </div>

        <!-- Input Area -->
        <div
            class="bg-gray-800 p-4 bottom-0 w-full flex-none absolute md:static border-t border-gray-700 md:border-t-0">
            <div class="max-w-3xl mx-auto relative">
                <textarea id="chat-input" rows="1"
                    class="w-full bg-gray-700 text-white rounded-lg pl-4 pr-12 py-3 focus:outline-none focus:ring-1 focus:ring-gray-500 resize-none overflow-hidden shadow-lg"
                    placeholder="Message Lumina AI..."
                    oninput="this.style.height = ''; this.style.height = Math.min(this.scrollHeight, 200) + 'px'"
                    onkeydown="handleEnter(event)"></textarea>
                <button id="send-btn" onclick="sendMessage()"
                    class="absolute right-3 bottom-3 text-gray-400 hover:text-white p-1 rounded-md transition disabled:opacity-50"
                    disabled>
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            <div class="text-center text-xs text-gray-500 mt-2 hidden md:block">Lumina AI can make mistakes. Verify
                important info.</div>
        </div>
    </main>
</div>
{% endblock %}

{% block scripts %}
<script>
    let activeChatId = null;
    const messagesContainer = document.getElementById('messages-container');
    const welcomeView = document.getElementById('welcome-view');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const chatList = document.getElementById('chat-list');

    // Init
    (async () => {
        if (!LuminaAPI.getAccessToken()) window.location.href = '/login/';
        await loadChatHistory();
    })();

    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('mobile-overlay');
        const isClosed = sidebar.classList.contains('-translate-x-full');

        if (isClosed) {
            sidebar.classList.remove('-translate-x-full');
            overlay.classList.remove('hidden');
        } else {
            sidebar.classList.add('-translate-x-full');
            overlay.classList.add('hidden');
        }
    }

    // Enable send button only if text exists
    chatInput.addEventListener('input', () => {
        sendBtn.disabled = !chatInput.value.trim();
    });

    function handleEnter(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (!sendBtn.disabled) sendMessage();
        }
    }

    async function loadChatHistory() {
        const res = await LuminaAPI.request('/chats/');
        if (res && res.ok) {
            const chats = await res.json();
            renderChatList(chats);
        }
    }

    function renderChatList(chats) {
        chatList.innerHTML = '';
        chats.forEach(chat => {
            const btn = document.createElement('button');
            btn.className = `w-full text-left px-4 py-3 rounded-md text-gray-300 hover:bg-gray-800 transition truncate text-sm mb-1 ${activeChatId === chat.id ? 'bg-gray-800' : ''}`;
            btn.textContent = chat.title || 'New Chat';
            btn.onclick = () => loadChat(chat.id);
            chatList.appendChild(btn); // Recent at top? API sorts updated_at desc
        });
    }

    function createNewChat() {
        activeChatId = null;
        messagesContainer.innerHTML = '';
        messagesContainer.appendChild(welcomeView);
        welcomeView.classList.remove('hidden');

        // Refresh list style
        Array.from(chatList.children).forEach(c => c.classList.remove('bg-gray-800'));

        // Close sidebar on mobile
        if (window.innerWidth < 768) toggleSidebar();
    }

    async function loadChat(id) {
        activeChatId = id;
        welcomeView.classList.add('hidden');

        // Highlight logic logic
        Array.from(chatList.children).forEach(c => c.classList.remove('bg-gray-800'));
        // Find button (complex without IDs, simple reload ok)
        loadChatHistory(); // Update highlights simply

        messagesContainer.innerHTML = '';
        const res = await LuminaAPI.request(`/chats/${id}/messages/`);
        if (res.ok) {
            const messages = await res.json();
            messages.forEach(appendMessage);
            scrollToBottom();
        }

        if (window.innerWidth < 768) toggleSidebar();
    }

    function appendMessage(msg) {
        // msg: {role, content}
        const isUser = msg.role === 'user';
        const div = document.createElement('div');
        div.className = `flex w-full ${isUser ? 'justify-end' : 'justify-start'}`;

        const bubble = document.createElement('div');
        bubble.className = `max-w-[85%] md:max-w-[70%] p-4 rounded-lg text-sm md:text-base ${isUser ? 'bg-gray-700 text-white rounded-br-none' : 'text-gray-100 rounded-bl-none'}`;

        if (isUser) {
            bubble.textContent = msg.content;
        } else {
            // Markdown render
            // Setup markdown logic if using marked
            bubble.innerHTML = marked.parse(msg.content);
        }

        // Add Avatar icon if Assistant
        if (!isUser) {
            div.innerHTML = `
             <div class="w-8 h-8 rounded-full bg-green-600 flex items-center justify-center mr-2 flex-none text-white text-xs">AI</div>
           `;
            div.appendChild(bubble);
        } else {
            div.appendChild(bubble);
        }

        messagesContainer.appendChild(div);
    }

    function scrollToBottom() {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    async function sendMessage() {
        const text = chatInput.value.trim();
        if (!text) return;

        chatInput.value = '';
        chatInput.style.height = 'auto'; // Reset height
        sendBtn.disabled = true;
        welcomeView.classList.add('hidden');

        // Optimistic render User Msg
        appendMessage({ role: 'user', content: text });
        scrollToBottom();

        // Loading Indicator
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'flex w-full justify-start';
        loadingDiv.innerHTML = `
             <div class="w-8 h-8 rounded-full bg-green-600 flex items-center justify-center mr-2 flex-none text-white text-xs">AI</div>
             <div class="flex items-center space-x-1 p-4">
                <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
             </div>
        `;
        messagesContainer.appendChild(loadingDiv);
        scrollToBottom();

        try {
            // Ensure chat exists
            if (!activeChatId) {
                const chatRes = await LuminaAPI.request('/chats/', {
                    method: 'POST',
                    body: JSON.stringify({ title: 'New Chat' }) // Title will update on server
                });
                const chat = await chatRes.json();
                activeChatId = chat.id;
                // Refresh list to show new chat
                loadChatHistory();
            }

            const res = await LuminaAPI.request(`/chats/${activeChatId}/message/`, {
                method: 'POST',
                body: JSON.stringify({ content: text })
            });

            messagesContainer.removeChild(loadingDiv);

            if (res.ok) {
                const msg = await res.json();
                appendMessage(msg);
                loadChatHistory(); // Title might update
            } else {
                appendMessage({ role: 'assistant', content: '**Error**: Failed to send message.' });
            }
        } catch (e) {
            messagesContainer.removeChild(loadingDiv);
            appendMessage({ role: 'assistant', content: '**Error**: Connection failed.' });
        }

        scrollToBottom();
    }

    function logout() {
        LuminaAPI.logout();
    }
</script>
{% endblock %}